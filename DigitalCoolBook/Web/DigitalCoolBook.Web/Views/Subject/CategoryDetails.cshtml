@model DigitalCoolBook.Web.Models.CategoryViewModels.CategoryDetailsViewModel

@{
    ViewData["Title"] = "Category Details";
    Layout = "_Layout";
}

<div class="offset-md-3 col-md-6 offset-sm-0 col-sm-12 mt-3">
    <h3>Topics</h3>
    <hr />
    <div class="mb-3">
        @foreach (var lesson in Model.Lessons)
        {
            <div class="row d-flex justify-content-center align-items-center">
                @if (this.User.IsInRole("Student"))
                {
                <div class="col-sm-7 d-flex align-content-center">
                    @if (lesson.IsUnlocked)
                    {
                        <a class="w-75 btn btn-success mb-2"
                           asp-controller="Subject"
                           asp-action="LessonDetails"
                           asp-route-lessonId="@lesson.LessonId">@lesson.Title</a>
                        <i class="fas fa-lg text-success ms-1 fa-unlock"></i>
                    }
                    else
                    {
                        <a class="w-75 btn btn-secondary mb-2 disabled" aria-disabled="true">@lesson.Title</a>
                        <i class="fas fa-lg fa-lock text-danger ms-1"></i>
                    }
                </div>
                    <div class="col-sm-4">
                        <h5 class="d-inline-block">Score:</h5>
                        @if (lesson.Score >= 70)
                        {
                            <h4 class="text-success ms-2 d-inline-block">@lesson.Score</h4>
                        }
                        else
                        {
                            <h4 class="ms-2 d-inline-block">@lesson.Score</h4>
                        }
                    </div>
                }
                @if (this.User.IsInRole("Teacher"))
                {
                    <a class="w-75 btn btn-primary"
                       asp-action="LessonDetails"
                       asp-controller="Subject"
                       asp-route-lessonId="@lesson.LessonId"
                       asp-route-subjectId="@Model.SubjectId">@lesson.Title</a>
                }
            </div>
            <div class="buttons-wrapper">
                @if (this.User.IsInRole("Admin"))
                {
                    <a class="btn btn-warning btn-sm"
                       asp-controller="Subject"
                       asp-action="EditLesson"
                       asp-route-id="@lesson.LessonId">
                        Edit
                    </a>
                    <a class="btn-sm btn btn-danger" id="@lesson.LessonId" href="#">Delete</a>
                }
            </div>
        }
    </div>
    <a asp-controller="Subject"
       asp-action="Subjects"><i class="fas fa-lg fa-arrow-circle-left"></i></a>

    @if (this.User.IsInRole("Admin"))
    {
        <a class="btn btn-success btn-sm mt-2" asp-action="AddLesson">Create</a>
    }
</div>

@if (this.User.IsInRole("Admin"))
{
    <div id="dialog-confirm" title="Delete">
        <p>
            <span class="ui-icon ui-icon-alert" style="float:left; margin:12px 12px 20px 0;"></span>
            The topic will be removed. Continue?
        </p>
    </div>

    <div id="successMessage"></div>

    <div style="display: none; " id="errorMessageDialog" title="Error">
        <p style="max-height:280px; overflow:auto;" id="errorMessage">
            <span class="ui-icon ui-icon-alert" style="float:left; margin:12px 12px 20px 0;"></span>
        </p>
    </div>
}


@section Scripts{
    <script>
        $(function () {
            $("#dialog-confirm").hide();
            $(".btn-delete").click(function () {
                $("#dialog-confirm").dialog({
                    modal: true,
                    buttons:
                    {
                        "Delete": function () {
                            var categoryId = $(".btn-delete").attr("id");
                            $.ajax({
                                url: "/Subject/DeleteLesson/" + categoryId,
                                type: "POST",
                                success: function () {
                                    $("#successMessage").dialog({
                                        modal: true,
                                        buttons: {
                                            "Close": function () {
                                                $(this).dialog("close");
                                            }
                                        }
                                    });
                                    $("#successMessage").html("Successfully removed");
                                },
                                error: function (request, err, message) {
                                    $("#errorMessage").html(request.statusText);
                                    $("#errorMessageDialog").dialog({
                                        modal: true,
                                        buttons: {
                                            "Close": function () {
                                                $(this).dialog("close");
                                            }
                                        }
                                    });
                                    //Use in release
                                    //$("#errorMessage").html("User can't be deleted");
                                }
                            });
                            $(this).dialog("close");
                        },
                        "Back": function () {
                            $(this).dialog("close");
                        }
                    }
                });
            });
        });
    </script>
}
